{
  "openapi": "3.0.0",
  "info": {
    "title": "人脸识别产线",
    "description": "人脸识别产线是专注于解决人脸定位和识别任务的端到端串联系统，可以从图像中快速准确地定位人脸区域、提取人脸特征，并与特征库中预先建立的特征做检索比对，从而确认身份信息",
    "version": "1.0.0"
  },
  "paths": {
    "/face-recognition-index-build": {
      "post": {
        "summary": "构建特征向量索引",
        "description": "构建人脸特征向量索引，用于后续识别",
        "operationId": "buildIndex",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "imageLabelPairs": {
                    "type": "array",
                    "items": {
                      "$ref": "#/components/schemas/ImageLabelPair"
                    },
                    "description": "用于构建索引的图像-标签对"
                  }
                },
                "required": ["imageLabelPairs"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "构建成功",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "../common_api_responses.json#/components/schemas/SuccessResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "$ref": "#/components/schemas/BuildIndexResult"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "../common_api_responses.json#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "服务器内部错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "../common_api_responses.json#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/face-recognition-index-add": {
      "post": {
        "summary": "将图像加入索引",
        "description": "将图像对应的特征向量加入已有的索引",
        "operationId": "addImagesToIndex",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "imageLabelPairs": {
                    "type": "array",
                    "items": {
                      "$ref": "#/components/schemas/ImageLabelPair"
                    },
                    "description": "用于添加到索引的图像-标签对"
                  },
                  "indexKey": {
                    "type": "string",
                    "description": "索引对应的键，由buildIndex操作提供"
                  }
                },
                "required": ["imageLabelPairs", "indexKey"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "添加成功",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "../common_api_responses.json#/components/schemas/SuccessResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "$ref": "#/components/schemas/AddImagesResult"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "../common_api_responses.json#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "服务器内部错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "../common_api_responses.json#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/face-recognition-index-remove": {
      "post": {
        "summary": "从索引中移除图像",
        "description": "从已有的索引中移除指定的特征向量",
        "operationId": "removeImagesFromIndex",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "ids": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "需要从索引中移除的向量的ID"
                  },
                  "indexKey": {
                    "type": "string",
                    "description": "索引对应的键，由buildIndex操作提供"
                  }
                },
                "required": ["ids", "indexKey"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "移除成功",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "../common_api_responses.json#/components/schemas/SuccessResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "$ref": "#/components/schemas/RemoveImagesResult"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "../common_api_responses.json#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "服务器内部错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "../common_api_responses.json#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/face-recognition-infer": {
      "post": {
        "summary": "进行图像识别",
        "description": "识别人脸图像并返回识别结果",
        "operationId": "infer",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "image": {
                    "oneOf": [
                      {
                        "type": "string",
                        "format": "uri",
                        "description": "服务器可访问的图像文件的URL"
                      },
                      {
                        "type": "string",
                        "format": "base64",
                        "description": "图像文件内容的Base64编码结果"
                      }
                    ],
                    "description": "服务器可访问的图像文件的URL或图像文件内容的Base64编码结果"
                  },
                  "indexKey": {
                    "type": "string",
                    "description": "索引对应的键，由buildIndex操作提供"
                  },
                  "detThreshold": {
                    "oneOf": [
                      {
                        "type": "number",
                        "format": "float"
                      },
                      {
                        "type": "null"
                      }
                    ],
                    "description": "检测阈值"
                  },
                  "recThreshold": {
                    "oneOf": [
                      {
                        "type": "number",
                        "format": "float"
                      },
                      {
                        "type": "null"
                      }
                    ],
                    "description": "识别阈值"
                  },
                  "hammingRadius": {
                    "oneOf": [
                      {
                        "type": "number",
                        "format": "float"
                      },
                      {
                        "type": "null"
                      }
                    ],
                    "description": "汉明半径"
                  },
                  "topk": {
                    "oneOf": [
                      {
                        "type": "integer"
                      },
                      {
                        "type": "null"
                      }
                    ],
                    "description": "返回的TopK结果数量"
                  },
                  "visualize": {
                    "oneOf": [
                      {
                        "type": "boolean"
                      },
                      {
                        "type": "null"
                      }
                    ],
                    "description": "是否返回可视化结果图以及处理过程中的中间图像等。传入true：返回图像；传入false：不返回图像；若未提供或传入null：遵循产线配置文件Serving.visualize的设置"
                  }
                },
                "required": ["image"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "识别成功",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "../common_api_responses.json#/components/schemas/SuccessResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "$ref": "#/components/schemas/InferResult"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "../common_api_responses.json#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "服务器内部错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "../common_api_responses.json#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "ImageLabelPair": {
        "type": "object",
        "description": "图像-标签对",
        "properties": {
          "image": {
            "oneOf": [
              {
                "type": "string",
                "format": "uri",
                "description": "服务器可访问的图像文件的URL"
              },
              {
                "type": "string",
                "format": "base64",
                "description": "图像文件内容的Base64编码结果"
              }
            ],
            "description": "服务器可访问的图像文件的URL或图像文件内容的Base64编码结果"
          },
          "label": {
            "type": "string",
            "description": "标签"
          }
        },
        "required": ["image", "label"]
      },
      "BuildIndexResult": {
        "type": "object",
        "description": "构建索引结果",
        "properties": {
          "indexKey": {
            "type": "string",
            "description": "索引对应的键，用于标识建立的索引。可用作其他操作的输入"
          },
          "imageCount": {
            "type": "integer",
            "description": "索引的图像数量"
          }
        },
        "required": ["indexKey", "imageCount"]
      },
      "AddImagesResult": {
        "type": "object",
        "description": "添加图像结果",
        "properties": {
          "imageCount": {
            "type": "integer",
            "description": "索引的图像数量"
          }
        },
        "required": ["imageCount"]
      },
      "RemoveImagesResult": {
        "type": "object",
        "description": "移除图像结果",
        "properties": {
          "imageCount": {
            "type": "integer",
            "description": "索引的图像数量"
          }
        },
        "required": ["imageCount"]
      },
      "InferResult": {
        "type": "object",
        "description": "识别结果",
        "properties": {
          "faces": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Face"
            },
            "description": "检测到的人脸的信息"
          },
          "image": {
            "oneOf": [
              {
                "type": "string",
                "format": "base64",
                "description": "识别结果图。图像为JPEG格式，使用Base64编码"
              },
              {
                "type": "null"
              }
            ],
            "description": "识别结果图"
          }
        },
        "required": ["faces"]
      },
      "Face": {
        "type": "object",
        "description": "人脸信息",
        "properties": {
          "bbox": {
            "type": "array",
            "items": {
              "type": "number",
              "format": "float"
            },
            "minItems": 4,
            "maxItems": 4,
            "description": "人脸目标位置。数组中元素依次为边界框左上角x坐标、左上角y坐标、右下角x坐标以及右下角y坐标"
          },
          "recResults": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/RecognitionResult"
            },
            "description": "识别结果"
          },
          "score": {
            "type": "number",
            "format": "float",
            "minimum": 0,
            "maximum": 1,
            "description": "检测得分"
          }
        },
        "required": ["bbox", "score"]
      },
      "RecognitionResult": {
        "type": "object",
        "description": "识别结果",
        "properties": {
          "label": {
            "type": "string",
            "description": "标签"
          },
          "score": {
            "type": "number",
            "format": "float",
            "minimum": 0,
            "maximum": 1,
            "description": "识别得分"
          }
        },
        "required": ["label", "score"]
      }
    }
  }
}
