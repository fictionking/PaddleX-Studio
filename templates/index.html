<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PaddleX-Studio</title>
    <style>
        #app .el-header {
            display: flex;
            align-items: center;
            padding: 0 20px;
            height: 60px;
            border-bottom: 1px solid #ebeef5;
        }

        #app .el-header .el-button {
            /* 未选中状态：白色背景、灰色文字、浅灰边框 */
            background: #ffffff;
            color: #606266;
            border: 1px solid #dcdfe6;
            min-width: 80px;
            margin-left: 20px;
        }

        #app .el-header .el-button.active {
            /* 选中状态：蓝色背景、白色文字、蓝色边框 */
            background: #409eff;
            color: #ffffff;
            border-color: #409eff;
        }

        #app .dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 20px;
        }

        .card-content {
            display: flex;
            justify-content: space-between;
            padding: 0px;
        }

        .page-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header h2 {
            font-size: 20px;
            color: #303133;
            margin: 0;
        }

        .model-desc {
            color: #909399;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .model-basic h3 {
            font-size: 16px;
            margin-right: 12px;
            margin-top: 0;
            margin-bottom: 0;
        }

        .model-category {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fine-tune-time {
            color: #606266;
            font-size: 14px;
            margin-bottom: 8px;
        }

        /* 新增提取的内联样式 */
        .page-header-info {
            display: flex;
            align-items: center;
            margin-top: 0;
            margin-bottom: 0;
            gap: 8px;
        }

        .left-section {
            flex: 2;
            margin-right: 20px;
        }

        .right-section {
            flex: 1;
            text-align: right;
        }

        .info-actions {
            margin-top: 8px;
        }

        .model-desc {
            color: #909399;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .paddlex-title {
            margin-right: 40px;
            color: #0047b9;
        }

        .model-card {
            margin-bottom: 20px;
        }

        .model-basic {
            display: flex;
            align-items: center;
            margin-top: 0;
            margin-bottom: 0;
        }

        .model-status {
            margin-bottom: 8px;
        }
    </style>

    <!-- 引入Vue3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入element-plus样式文件 -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <!-- 引入element-plus组件库 -->
    <script src="https://unpkg.com/element-plus"></script>
    <!-- 引入element-plus所有图标 -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <!-- 引入axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

</head>

<body>
    <div id="app">

        <el-container>
            <el-header>
                <h1 class="paddlex-title">PaddleX Studio</h1>
                <el-button type="primary" :class="{ active: currentPage === 'model' }"
                    @click="navigateTo('model')"><el-icon class="icon">
                        <ICO_HelpFilled />
                    </el-icon>模型</el-button>
                <el-button type="primary" :class="{ active: currentPage === 'dataset' }"
                    @click="navigateTo('dataset')"><el-icon class="icon">
                        <ICO_Menu />
                    </el-icon>数据</el-button>
            </el-header>
            <el-main>
                <!-- 模型列表页面 -->
                <div v-if="currentPage === 'model'">
                    <div v-if="modelPage ==='model_list'">
                        <div class="page-header">
                            <h2 class="page-header h2">模型空间</h2>
                            <el-button type="primary" plain
                                @click="() => { if(this.$refs.newModelForm) this.$refs.newModelForm.resetFields(); moduleDescription='';pretrainedDescription='';dialogVisible = true; }">创建模型</el-button>
                        </div>

                        <el-row :gutter="20">
                            <el-col :span="24">
                                <el-card class="model-card" v-for="(model, index) in models" :key="index"
                                    @click="modelTrain(model.id)">
                                    <div class="card-content">
                                        <!-- 左侧内容 -->
                                        <div class="left-section">
                                            <div class="model-basic">
                                                <h3 class="model-basic h3" v-text="model.name"></h3>
                                                <el-tag type="info" effect="plain" style="font-size: 14px;"
                                                    v-text="model.pretrained"></el-tag>
                                            </div>
                                            <p class="model-desc" v-text="model.description"></p>
                                            <div class="model-category">
                                                <el-tag type="success" v-text="model.category"></el-tag>
                                                <el-tag type="success" v-text="model.module_name"></el-tag>
                                            </div>
                                        </div>
                                        <!-- 右侧内容 -->
                                        <div class="right-section">
                                            <p class="fine-tune-time" v-text="model.fine_tune_time"></p>
                                            <div class="model-status">
                                                <el-tag
                                                    :type="model.status === '成功' ? 'success' : model.status === '训练中' ? 'primary' : model.status === '失败' ? 'danger': 'info'"
                                                    v-text="model.status"></el-tag>
                                            </div>
                                            <div class="info-actions" style="margin-top: 8px;">
                                                <el-button type="text"
                                                    @click.stop="handleModelDelete(model.id)">删除</el-button>
                                            </div>
                                        </div>
                                    </div>
                                </el-card>
                            </el-col>
                        </el-row>
                    </div>
                    <!-- 训练页面 -->
                    <div v-if="modelPage ==='model_detail'">
                        <div class="page-header">
                            <div class="page-header-info">
                                <h2 class="page-header h2" v-text="currentModel.name"></h2>
                                <el-tag type="info" effect="plain" style="font-size: 14px;"
                                    v-text="currentModel.pretrained"></el-tag>
                                <el-tag type="success" v-text="currentModel.category"></el-tag>
                                <el-tag type="success" v-text="currentModel.module_name"></el-tag>
                            </div>
                            <el-button type="primary" plain @click="modelPage = 'model_list'">返回</el-button>
                        </div>
                        <p class="model-desc" v-text="currentModel.description"></p>
                        <br>
                        <el-steps style="max-width: 900px; margin: 0 auto;" :space="300"
                            :active="currentModel.status === '未开始' ? 0 : (['未训练', '训练中'].includes(currentModel.status) ? 1 : 2)"
                            align-center finish-status="success">
                            <el-step title="选择数据集"></el-step>
                            <el-step title="训练"></el-step>
                            <el-step :title="currentModel.status === '成功' ?'成功':currentModel.status === '失败'?'失败':'完成'"
                                :status="currentModel.status === '成功' ?'success':currentModel.status === '失败'?'error':''"></el-step>
                        </el-steps>

                        <!-- 数据集选择 -->
                        <div style="align-items: center;text-align: center;">
                            <br>
                            <el-button type="primary" @click="showDatasetDialog = true"
                                :disabled="checkingDataset">选择训练数据集</el-button>
                            <div style="display: flex;margin:0 auto;margin-top: 10px;gap: 20px;align-items: center;"
                                v-if="currentModel.dataset_id">
                                已选数据集：<el-text v-text="currentModel.dataset_name"></el-text>
                                <el-button type="primary" @click="handleCheckDataset"
                                    :disabled="checkingDataset">检查数据集</el-button>
                            </div>
                            <div v-show="showCheckResult" style="margin-top: 20px;">
                                <el-card>
                                    <h3>检查状态：<el-tag :type="checkPass ? 'success' : 'danger'"
                                            v-text="checkPass ? '通过' : '未通过'"></el-tag></h3>
                                    <div v-show="!checkPass">
                                        <el-input v-if="!checkPass" v-model="checkLog" style="width: 100%;" :rows="20"
                                            type="textarea" placeholder="检查日志内容将显示在此处" />
                                    </div>

                                    <div  v-if="checkResult" v-show="checkPass">
                                        <el-row :gutter="20" style="height: 600px;">
                                            <!-- 左边图片区域 -->
                                            <el-col :span="16"
                                                style="display: flex; flex-direction: column; border-right: 1px solid #eee;">
                                                <div style="flex: 1; padding-bottom: 10px;">
                                                    <h4>训练集信息</h4>
                                                    <p>样本数量：<el-text
                                                            v-text="checkResult.attributes.train_samples"></el-text></p>
                                                    <div class="image-grid">
                                                        <el-image
                                                            v-for="path in checkResult.attributes.train_sample_paths"
                                                            :key="path" :src="path"
                                                            style="width: 100px; height: 100px; margin: 5px"
                                                            fit="cover"></el-image>
                                                    </div>
                                                </div>
                                                <div style="flex: 1; padding-top: 10px;">
                                                    <h4>验证集信息</h4>
                                                    <p>样本数量：<el-text
                                                            v-text="checkResult.attributes.val_samples"></el-text>
                                                    </p>
                                                    <div class="image-grid">
                                                        <el-image
                                                            v-for="path in checkResult.attributes.val_sample_paths"
                                                            :key="path" :src="path"
                                                            style="width: 100px; height: 100px; margin: 5px"
                                                            fit="cover"></el-image>
                                                    </div>
                                                </div>
                                            </el-col>
                                            <!-- 右边统计图区域 -->
                                            <el-col :span="8"
                                                style="display: flex; align-items: center; justify-content: center;">
                                                <div style="width: 100%;">
                                                    <h4>数据分布统计图</h4>
                                                    <el-image :src="checkResult.analysis.histogram"
                                                        style="max-width: 100%;" fit="contain"></el-image>
                                                </div>
                                            </el-col>
                                        </el-row>
                                    </div>

                                </el-card>
                            </div>
                            <div
                                style="position: fixed; bottom: 0; left: 0; right: 0; padding: 20px; background: #ffffff;">
                                <el-button type="primary" @click="currentModel.status='未训练'"
                                    :disabled="!checkPass">下一步</el-button>
                            </div>
                        </div>
                        <el-dialog title="选择数据集" v-model="showDatasetDialog" width="30%">
                            <el-select v-model="currentModel.dataset_id" placeholder="请选择数据集"
                                @change="handleDatasetChange">
                                <el-option v-for="dataset in datasets" :key="dataset.id" :label="dataset.name"
                                    :value="dataset.id"></el-option>
                            </el-select>
                            <div slot="footer" class="dialog-footer">
                                <el-button @click="showDatasetDialog = false">取消</el-button>
                                <el-button type="primary" @click="showDatasetDialog = false">确定</el-button>
                            </div>
                        </el-dialog>


                    </div>
                    <!-- 创建模型对话框 -->
                    <el-dialog title="新建模型训练配置" v-model="dialogVisible" width="50%">
                        <el-form ref="newModelForm" :model="newModelFormData" :rules="formRules" label-width="120px">
                            <div style="display: flex;gap: 20px;">
                                <div style="flex: 1;">
                                    <el-form-item label="模型名称" prop="name" required>
                                        <el-input v-model="newModelFormData.name"></el-input>
                                    </el-form-item>
                                    <el-form-item label="唯一标识" prop="id" required>
                                        <el-input v-model="newModelFormData.id" placeholder="仅支持大小写字母、数字、-、_"
                                            oninput="value=value.replace(/[^a-zA-Z0-9-_]/g,'')"></el-input>
                                    </el-form-item>
                                    <el-form-item label="模型描述" prop="description" required>
                                        <el-input type="textarea" v-model="newModelFormData.description"></el-input>
                                    </el-form-item>
                                    <el-form-item label="类别" prop="category" required>
                                        <el-select v-model="newModelFormData.category" placeholder="请选择类别"
                                            @change="handleCategoryChange">
                                            <el-option v-for="cat in categoryOptions" :key="cat.category"
                                                :label="cat.category" :value="cat.category"></el-option>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="模块" prop="module_id" required>
                                        <el-select v-model="newModelFormData.module_id" placeholder="请选择模块"
                                            @change="handleModuleChange">
                                            <el-option v-for="mod in moduleOptions" :key="mod.name" :label="mod.name"
                                                :value="mod.id"></el-option>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="预训练模型" prop="pretrained" required>
                                        <el-select v-model="newModelFormData.pretrained" placeholder="请选择预训练模型"
                                            @change="handlePretrainedChange">
                                            <el-option v-for="pretrained in pretrainedOptions" :key="pretrained.name"
                                                :label="pretrained.name" :value="pretrained.name"></el-option>
                                        </el-select>
                                    </el-form-item>
                                </div>
                                <div style="flex: 1; height: 100%;">
                                    <el-text tag="b">模块描述</el-text>
                                    <el-input type="textarea" v-model="moduleDescription" readonly :rows="6"></el-input>
                                    <el-text tag="b">预训练模型描述</el-text>
                                    <el-input type="textarea" v-model="pretrainedDescription" readonly
                                        :rows="6"></el-input>
                                </div>
                            </div>
                        </el-form>

                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogVisible = false">取消</el-button>
                            <el-button type="primary" @click="handleModelSave">保存</el-button>
                        </div>
                    </el-dialog>


                </div>
                <!-- 数据集列表页面 -->
                <div v-if="currentPage ==='dataset'">
                    <div class="page-header">
                        <h2 class="page-header h2">数据集</h2>
                        <el-button type="primary" plain>创建数据集</el-button>
                    </div>
                    <el-row :gutter="20">
                        <el-col :span="24">
                            <el-card class="box-card" v-for="(dataset, index) in datasets" :key="index"
                                style="margin-bottom: 20px;">
                                <div slot="header" class="clearfix">
                                    <span v-text="dataset.name"></span>
                                    <el-tag type="success" style="float: right;" v-text="dataset.category"></el-tag>
                                </div>
                                <p v-text="dataset.description"></p>
                                <el-button type="primary" size="small">操作</el-button>
                        </el-col>
                    </el-row>
                </div>

            </el-main>

        </el-container>

    </div>
    <script>
        const { createApp } = Vue
        const { ElMessage, ElIcon, Document, Folder, ElCard, ElForm } = ElementPlus  // 新增导入ElCard组件

        createApp({
            data() {
                return {
                    currentPage: 'model',  // 默认显示模型列表页面
                    modelPage: 'model_list',  // 默认显示模型列表页面
                    currentModel: null,  // 当前选中的模型
                    models: [],  // 初始化模型数组
                    datasets: [],  // 新增数据集数组
                    dialogVisible: false,
                    showDatasetDialog: false,
                    checkResult: null,
                    checkingDataset: false,
                    checkPass: false,
                    showCheckResult: false,
                    checkLog: '',
                    newModelFormData: {
                        name: '',
                        id: '',
                        description: '',
                        category: '',
                        module_id: '',
                        module_name: '',
                        pretrained: ''
                    },
                    formRules: {
                        name: [
                            { required: true, message: '请输入模型名称', trigger: 'blur' }
                        ],
                        id: [
                            { required: true, message: '请输入唯一标识', trigger: 'blur' },
                            { pattern: /^[a-zA-Z0-9-_]+$/, message: '仅支持大小写字母、数字、-、_', trigger: 'blur' },
                            { validator: this.checkModelUniqueId, trigger: 'blur' }
                        ],
                        description: [
                            { required: true, message: '请输入模型描述', trigger: 'blur' }
                        ],
                        category: [
                            { required: true, message: '请选择类别', trigger: 'change' }
                        ],
                        module_id: [
                            { required: true, message: '请选择模块', trigger: 'change' }
                        ],
                        pretrained: [
                            { required: true, message: '请选择预训练模型', trigger: 'change' }
                        ]
                    },
                    categoryOptions: [],
                    moduleOptions: [],
                    pretrainedOptions: [],
                    moduleDescription: '',
                    pretrainedDescription: ''
                }
            },
            mounted() {
                // 页面加载后调用API获取模型数据
                this.loadModels();
                this.loadDatasets();
                // 加载modules.json数据填充选项
                fetch('/modules.json')
                    .then(res => res.json())
                    .then(data => {
                        this.categoryOptions = data;
                    });

            },
            methods: {
                async handleCheckDataset() {
                    if (this.checkingDataset) return;
                    this.checkingDataset = true;
                    this.checkPass = false;
                    await this.$nextTick();
                    try {
                        const response = await axios.post(`/models/${this.currentModel.id}/check`, {
                            dataset_id: this.currentModel.dataset_id
                        });
                        if (response.data.code === 200) {
                            this.checkResult = response.data.data;
                            this.checkPass = this.checkResult.check_pass;
                        }
                        this.showCheckResult = true;
                        if (!this.checkPass) {
                            try {
                                const logResponse = await axios.get(`/models/${this.currentModel.id}/check/check_dataset.log`);
                                this.checkLog = logResponse.data;
                            } catch (error) {
                                this.$message.error('获取日志失败：' + error.message);
                            }
                        }
                    } catch (error) {
                        this.$message.error('网络请求失败：' + error.message);
                    } finally {
                        this.checkingDataset = false;
                    }

                },
                navigateTo(page) {
                    this.currentPage = page;
                },
                loadDatasets() {
                    // 调用API获取数据集数据
                    fetch('/datasets')
                        .then(response => response.json())
                        .then(data => {
                            this.datasets = data;
                        })
                        .catch(error => {
                            console.error('获取数据集数据失败:', error);
                        });
                },
                loadModels() {
                    // 调用API获取模型数据
                    fetch('/models')
                        .then(response => response.json())
                        .then(data => {
                            this.models = data;
                        })
                        .catch(error => {
                            console.error('获取模型数据失败:', error);
                        });
                },
                modelTrain(modelId) {
                    // 调用API获取模型详细信息（GET方法无需body，通过URL参数传递modelId）
                    fetch(`/models/${modelId}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    }).then(res => res.json())
                        .then(result => {
                            // 将获取到的模型数据赋值给currentModel
                            this.currentModel = result;
                            this.modelPage = 'model_detail';
                        });
                },
                handleModelSave() {
                    this.$refs.newModelForm.validate((valid) => {
                        if (valid) {
                            // 调用后端接口保存模型配置（需与app.py的save_model_config接口对应）
                            modelId = this.newModelFormData.id;
                            fetch('/models/new', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(this.newModelFormData)
                            }).then(res => res.json())
                                .then(result => {
                                    if (result.code === 200) {
                                        this.dialogVisible = false;
                                        this.newModelFormData = {
                                            name: '',
                                            id: '',
                                            description: '',
                                            category: '',
                                            module_id: '',
                                            module_name: '',
                                            pretrained: ''
                                        };
                                        // 刷新模型列表（假设存在刷新方法）
                                        this.loadModels();
                                        this.modelTrain(modelId);
                                    }
                                });
                        } else {
                            // 校验失败提示
                            console.error('表单校验失败');
                            return false;
                        }
                    });

                },
                handleModelDelete(modelId) {
                    this.$confirm('确定要删除该模型吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        axios.get(`/models/${this.currentModel.id}/delete`)
                            .then(response => {
                                if (response.data.code === 200) {
                                    this.loadModels();
                                    this.$message.success('删除成功');
                                } else {
                                    this.$message.error(response.data.message);
                                }
                            })
                            .catch(error => {
                                this.$message.error('删除失败');
                                console.error(error);
                            });
                    }).catch(() => {
                        this.$message.info('已取消删除');
                    });
                },
                handleCategoryChange(val) {
                    // 从categoryOptions中找到当前选中类别的modules属性
                    const currentCategory = this.categoryOptions.find(cat => cat.category === val);
                    if (currentCategory) {
                        this.moduleOptions = currentCategory.modules;
                    } else {
                        this.moduleOptions = [];
                    }
                    this.pretrainedOptions = [];
                    this.newModelFormData.module = '';
                    this.newModelFormData.pretrained = '';
                    this.moduleDescription = '';
                    this.pretrainedDescription = '';
                },
                handleModuleChange(val) {
                    // 从moduleOptions中找到当前选中模块的pretrained属性
                    const currentModule = this.moduleOptions.find(mod => mod.id === val);
                    if (currentModule) {
                        this.pretrainedOptions = currentModule.pretrained;
                        this.moduleDescription = currentModule.description;
                        this.newModelFormData.module_name = currentModule.name;
                    } else {
                        this.pretrainedOptions = [];
                    }
                    this.newModelFormData.pretrained = '';
                    this.pretrainedDescription = '';
                },
                handlePretrainedChange(val) {
                    // 从pretrainedOptions中找到当前选中预训练模型的description属性
                    const currentPretrained = this.pretrainedOptions.find(pretrained => pretrained.name === val);
                    if (currentPretrained) {
                        this.pretrainedDescription = currentPretrained.description + '\n' + currentPretrained.model_size;
                    }
                },
                handleDatasetChange(val) {
                    const selectedDataset = this.datasets.find(dataset => dataset.id === val);
                    if (selectedDataset) {
                        this.currentModel.dataset_name = selectedDataset.name;
                    }
                },
                checkModelUniqueId(rule, value, callback) {
                    if (!value) {
                        return callback(new Error('唯一标识不能为空'));
                    }
                    const isExist = this.models.some(model => model.id === value);
                    if (isExist) {
                        callback(new Error('该唯一标识已存在'));
                    } else {
                        callback();
                    }
                }
            },
            components: {
                ElIcon, Document, Folder, ElCard, ElForm,  // 注册ElForm及ElCard组件（已正确导入）
                'ico_helpfilled': ElementPlusIconsVue.HelpFilled,
                'ico_menu': ElementPlusIconsVue.Menu,
                'ico_delete': ElementPlusIconsVue.Delete
            }
        }).use(ElementPlus).mount('#app')

    </script>
</body>

</html>